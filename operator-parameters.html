

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Operator Parameters &mdash; metalfs  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Buildpacks" href="buildpacks.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> metalfs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Metal FS Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker-dev.html">Docker-based Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Topics</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Operator Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#receiving-operator-parameters-in-hardware">Receiving Operator Parameters in Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#declaring-parameters-in-the-operator-manifest">Declaring Parameters in the Operator Manifest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-operator-parameters-c-api">Setting Operator Parameters (C++ API)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="buildpacks.html">Buildpacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-manifest.html">Image Manifest</a></li>
<li class="toctree-l1"><a class="reference internal" href="operator-manifest.html">Operator Manifest</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="metal-pipeline.html">Metal Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="metal-filesystem.html">Metal Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="metal-filesystem-pipeline.html">Metal Filesystem Pipeline</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Index</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">metalfs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Operator Parameters</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/operator-parameters.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="operator-parameters">
<h1>Operator Parameters<a class="headerlink" href="#operator-parameters" title="Permalink to this headline">¶</a></h1>
<p>Typically, an operator needs additional data at runtime to perform its data transformation.
Such parameters apply to the entire data stream and could be encryption keys, numeric values for data filters or enumeration values to switch between different modes of operation.</p>
<p>Therefore, Metal FS provides capabilities to define parameters as part of the operator hardware description and handles filling in the parameter data at runtime.</p>
<div class="section" id="receiving-operator-parameters-in-hardware">
<h2>Receiving Operator Parameters in Hardware<a class="headerlink" href="#receiving-operator-parameters-in-hardware" title="Permalink to this headline">¶</a></h2>
<p>In this section, the use of operator parameters is discussed in the context of HLS operators.
If you’re using another hardware description language, you have to manually add the logic to receive parameter data through the AXI register interface of the operator, at an address offset of your choice.</p>
<p>With HLS, parameters are added as part of your top-level method signature.
Here’s an example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">filter</span><span class="p">(</span>
        <span class="n">mtl_stream</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span>
        <span class="n">mtl_stream</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">lower_bound</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">upper_bound</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The basic operator directives:</span>
    <span class="cp">#pragma HLS INTERFACE axis port=in name=axis_input</span>
    <span class="cp">#pragma HLS INTERFACE axis port=out name=axis_output</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=return bundle=control</span>

    <span class="c1">// Parameter-specific directives</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=lower_bound bundle=control offset=0x100</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=upper_bound bundle=control offset=0x110</span>

    <span class="c1">// [Operator logic]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here’s another example with a parameter that contains a buffer of bytes.
Note that this operator also uses the optional <code class="docutils literal notranslate"><span class="pre">prepare</span></code> phase, which allows it to perform potentially time-consuming initialization steps before the actual processing phase.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">encrypt</span><span class="p">(</span>
        <span class="n">mtl_stream</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span>
        <span class="n">mtl_stream</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span>
        <span class="n">ap_uint</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">prepare</span><span class="p">,</span>
        <span class="n">ap_uint</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">key_bytes</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Basic operator directives</span>
    <span class="cp">#pragma HLS INTERFACE axis port=in name=axis_input</span>
    <span class="cp">#pragma HLS INTERFACE axis port=out name=axis_output</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=return bundle=control</span>

    <span class="c1">// The &#39;prepare&#39; parameter *must* be located at this offset</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=prepare bundle=control offset=0x010</span>

    <span class="c1">// Additional parameters</span>
    <span class="cp">#pragma HLS INTERFACE s_axilite port=key_bytes bundle=control offset=0x100</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Perform initialization of internal state here.</span>
        <span class="c1">// Do *not* read or write to the in/out streams here.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// The regular operator processing loop goes here.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The specific offsets of custom parameters can be freely chosen, as long as they don’t interfere with the HLS register interface and the <cite>prepare</cite> parameter.
A starting offset of <code class="docutils literal notranslate"><span class="pre">0x100</span></code> works well.</p>
</div>
<div class="section" id="declaring-parameters-in-the-operator-manifest">
<h2>Declaring Parameters in the Operator Manifest<a class="headerlink" href="#declaring-parameters-in-the-operator-manifest" title="Permalink to this headline">¶</a></h2>
<p>The detailed schema of the operator manifest is described [here](operator_manifest).
For instance, the manifest of the <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> operator above could look like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;encrypt&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Encrypt the data&quot;</span><span class="p">,</span>
    <span class="nt">&quot;prepare_required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;short&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;buffer&quot;</span><span class="p">,</span> <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span> <span class="p">},</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The encryption key to use&quot;</span><span class="p">,</span>
            <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">256</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the parameter offset is given as a decimal value (0x100 = 256).</p>
</div>
<div class="section" id="setting-operator-parameters-c-api">
<h2>Setting Operator Parameters (C++ API)<a class="headerlink" href="#setting-operator-parameters-c-api" title="Permalink to this headline">¶</a></h2>
<p>Once you’ve obtained an <a class="reference internal" href="metal-pipeline.html#_CPPv4N5metal8OperatorE" title="metal::Operator"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Operator</span></code></a> object from the <a class="reference internal" href="metal-pipeline.html#_CPPv4N5metal15OperatorFactoryE" title="metal::OperatorFactory"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">OperatorFactory</span></code></a>, refer to the desired parameter by name to provide its value.
Example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">keyBytes</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

<span class="n">SnapAction</span> <span class="n">fpga</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">OperatorFactory</span><span class="o">::</span><span class="n">fromFPGA</span><span class="p">(</span><span class="n">fpga</span><span class="p">);</span>

<span class="k">auto</span> <span class="n">encrypt</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">createOperator</span><span class="p">(</span><span class="s">&quot;encrypt&quot;</span><span class="p">);</span>
<span class="n">encrypt</span><span class="p">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span> <span class="n">keyBytes</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="buildpacks.html" class="btn btn-neutral float-right" title="Buildpacks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Robert Schmid

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>